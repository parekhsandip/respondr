{% extends "base.html" %}

{% block title %}Inbox - Respondr{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Inbox</h1>
        <p class="text-gray-600 mt-1">Manage your email tickets</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Sidebar -->
        <div class="lg:w-64 flex-shrink-0">
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <!-- Search -->
                <div class="p-4 border-b border-gray-200">
                    <form hx-get="{{ url_for('tickets_list') }}" hx-target="#ticket-list" hx-trigger="submit, keyup delay:500ms from:input[name='search']">
                        <div class="relative">
                            <input
                                type="text"
                                name="search"
                                value="{{ search_query }}"
                                placeholder="Search tickets..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <input type="hidden" name="status" value="{{ status_filter }}">
                    </form>
                </div>

                <!-- Status Filters -->
                <div class="p-4">
                    <h3 class="text-sm font-medium text-gray-900 mb-3">Status</h3>
                    <nav class="space-y-1">
                        <a href="{{ url_for('index', status='all', search=search_query) }}"
                           class="{% if status_filter == 'all' %}bg-blue-50 text-blue-700 border-blue-200{% else %}text-gray-700 hover:bg-gray-50{% endif %} group flex items-center px-3 py-2 text-sm font-medium rounded-md border transition-colors">
                            <svg class="{% if status_filter == 'all' %}text-blue-500{% else %}text-gray-400 group-hover:text-gray-500{% endif %} flex-shrink-0 -ml-1 mr-3 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-4.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H2"></path>
                            </svg>
                            All Tickets
                        </a>

                        <a href="{{ url_for('index', status='new', search=search_query) }}"
                           class="{% if status_filter == 'new' %}bg-blue-50 text-blue-700 border-blue-200{% else %}text-gray-700 hover:bg-gray-50{% endif %} group flex items-center px-3 py-2 text-sm font-medium rounded-md border transition-colors">
                            <span class="{% if status_filter == 'new' %}bg-blue-500{% else %}bg-red-500{% endif %} flex-shrink-0 w-2 h-2 rounded-full mr-3 ml-1"></span>
                            New
                        </a>

                        <a href="{{ url_for('index', status='read', search=search_query) }}"
                           class="{% if status_filter == 'read' %}bg-blue-50 text-blue-700 border-blue-200{% else %}text-gray-700 hover:bg-gray-50{% endif %} group flex items-center px-3 py-2 text-sm font-medium rounded-md border transition-colors">
                            <span class="{% if status_filter == 'read' %}bg-blue-500{% else %}bg-green-500{% endif %} flex-shrink-0 w-2 h-2 rounded-full mr-3 ml-1"></span>
                            Read
                        </a>

                        <a href="{{ url_for('index', status='archived', search=search_query) }}"
                           class="{% if status_filter == 'archived' %}bg-blue-50 text-blue-700 border-blue-200{% else %}text-gray-700 hover:bg-gray-50{% endif %} group flex items-center px-3 py-2 text-sm font-medium rounded-md border transition-colors">
                            <span class="{% if status_filter == 'archived' %}bg-blue-500{% else %}bg-gray-500{% endif %} flex-shrink-0 w-2 h-2 rounded-full mr-3 ml-1"></span>
                            Archived
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 min-w-0">
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <!-- Ticket List Header -->
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-medium text-gray-900">
                            {% if status_filter == 'new' %}
                                New Tickets
                            {% elif status_filter == 'read' %}
                                Read Tickets
                            {% elif status_filter == 'archived' %}
                                Archived Tickets
                            {% else %}
                                All Tickets
                            {% endif %}
                        </h2>
                        <div class="text-sm text-gray-500">
                            {{ tickets.total }} ticket{{ 's' if tickets.total != 1 else '' }}
                        </div>
                    </div>
                </div>

                <!-- Ticket List -->
                <div id="ticket-list"
                     hx-get="{{ url_for('tickets_list', status=status_filter, search=search_query) }}"
                     hx-trigger="refresh from:body"
                     class="divide-y divide-gray-200 custom-scrollbar max-h-screen overflow-y-auto">
                    {% include 'components/ticket_list.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div id="ticket-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div id="ticket-modal-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    // Handle ticket click to open modal
    function openTicketModal(ticketId) {
        const modal = document.getElementById('ticket-modal');
        const modalContent = document.getElementById('ticket-modal-content');

        modal.classList.remove('hidden');

        // Load ticket content
        htmx.ajax('GET', `/ticket/${ticketId}`, {
            target: '#ticket-modal-content',
            swap: 'innerHTML'
        });
    }

    // Close modal
    function closeTicketModal() {
        document.getElementById('ticket-modal').classList.add('hidden');
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeTicketModal();
        }
    });

    // Close modal when clicking outside
    document.getElementById('ticket-modal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeTicketModal();
        }
    });

    // Handle ticket status updates
    function updateTicketStatus(ticketId, status) {
        htmx.ajax('POST', `/api/ticket/${ticketId}/mark-${status}`, {
            swap: 'none'
        }).then(function() {
            // Refresh ticket list
            htmx.trigger('#ticket-list', 'refresh');
            showToast(`Ticket marked as ${status}`, 'success');
        });
    }

    // Handle archive ticket
    function archiveTicket(ticketId) {
        htmx.ajax('POST', `/api/ticket/${ticketId}/archive`, {
            swap: 'none'
        }).then(function() {
            // Refresh ticket list
            htmx.trigger('#ticket-list', 'refresh');
            showToast('Ticket archived', 'success');
            closeTicketModal();
        });
    }
</script>
{% endblock %}