{% extends "base.html" %}

{% block title %}Inbox - Respondr{% endblock %}

{% block content %}
<div class="h-full flex flex-col bg-gray-50">
    <!-- Header with Search -->
    <div class="bg-white shadow-sm border-b">
        <!-- Main Header with Search Bar -->
        <div class="px-4 py-3">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Respondr</h1>
                <div class="flex items-center space-x-4">
                    <div id="ticket-count" class="text-sm text-gray-600"></div>
                    <button onclick="openNewTicketModal()"
                            class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        New Ticket
                    </button>
                    <!-- Refresh Dropdown -->
                    <div class="relative" id="refresh-dropdown-container">
                        <button onclick="toggleRefreshDropdown()"
                                class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200">
                            <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="refresh-dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-50">
                            <div class="py-1">
                                <button onclick="setRefreshInterval('manual')"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Manual Refresh
                                </button>
                                <button onclick="setRefreshInterval(30)"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Every 30 seconds
                                </button>
                                <button onclick="setRefreshInterval(60)"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Every 1 minute
                                </button>
                                <button onclick="setRefreshInterval(300)"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Every 5 minutes
                                </button>
                                <button onclick="setRefreshInterval(600)"
                                        class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Every 10 minutes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Always Visible Search Bar -->
            <div class="flex items-center space-x-4">
                <!-- Search Input -->
                <div class="flex-1 relative">
                    <input type="text" id="search-text" placeholder="Search tickets..."
                           onkeyup="debounceSearch()"
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Advanced Filters Toggle -->
                <button onclick="toggleAdvancedSearch()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span>Filters</span>
                    <svg id="search-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Advanced Filters Panel -->
        <div id="advanced-search-panel" class="hidden border-t bg-gray-50 p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Assignee Filter -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Assignee</label>
                    <button type="button" onclick="toggleMultiSelectDropdown('assignee')"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white text-left flex items-center justify-between">
                        <span id="filter-assignee-label" class="truncate">All Assignees</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="filter-assignee-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                        <div class="p-2 space-y-1">
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="unassigned" class="filter-assignee-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('assignee')">
                                <span class="ml-2 text-sm text-gray-700">Unassigned</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Priority Filter -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                    <button type="button" onclick="toggleMultiSelectDropdown('priority')"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white text-left flex items-center justify-between">
                        <span id="filter-priority-label" class="truncate">All Priorities</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="filter-priority-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                        <div class="p-2 space-y-1">
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="1" class="filter-priority-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('priority')">
                                <span class="ml-2 text-sm text-gray-700">🔴 Urgent</span>
                            </label>
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="2" class="filter-priority-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('priority')">
                                <span class="ml-2 text-sm text-gray-700">🟠 High</span>
                            </label>
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="3" class="filter-priority-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('priority')">
                                <span class="ml-2 text-sm text-gray-700">🟡 Normal</span>
                            </label>
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="4" class="filter-priority-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('priority')">
                                <span class="ml-2 text-sm text-gray-700">🔵 Low</span>
                            </label>
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" value="5" class="filter-priority-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('priority')">
                                <span class="ml-2 text-sm text-gray-700">⚪ Very Low</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Type Filter -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                    <button type="button" onclick="toggleMultiSelectDropdown('type')"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white text-left flex items-center justify-between">
                        <span id="filter-type-label" class="truncate">All Types</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="filter-type-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                        <div id="filter-type-options" class="p-2 space-y-1">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Organization Filter -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Organization</label>
                    <button type="button" onclick="toggleMultiSelectDropdown('organization')"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white text-left flex items-center justify-between">
                        <span id="filter-organization-label" class="truncate">All Organizations</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="filter-organization-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                        <div id="filter-organization-options" class="p-2 space-y-1">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Tag Filter -->
                <div class="relative">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Tag</label>
                    <button type="button" onclick="toggleMultiSelectDropdown('tag')"
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-white text-left flex items-center justify-between">
                        <span id="filter-tag-label" class="truncate">All Tags</span>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="filter-tag-dropdown" class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                        <div id="filter-tag-options" class="p-2 space-y-1">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Date From -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" id="filter-date-from" onchange="applyFilters()"
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Date To -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" id="filter-date-to" onchange="applyFilters()"
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Spacer for grid alignment -->
                <div></div>
            </div>

            <!-- Filter Actions -->
            <div class="flex justify-between items-center mt-4">
                <button onclick="openSaveFilterModal()" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    <span>Save Filter</span>
                </button>
                <div class="flex space-x-2">
                    <button onclick="clearFilters()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900">
                        Clear All
                    </button>
                    <button onclick="applyFilters()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Saved Filters Panel -->
        <div id="saved-filters-panel" class="border-t bg-white p-4 hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    Saved Filters
                </h3>
                <button onclick="toggleSavedFilters()" class="text-sm text-gray-500 hover:text-gray-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="saved-filters-list" class="space-y-2">
                <!-- Saved filters will be loaded here -->
            </div>
        </div>

        <!-- Status Filter Tabs -->
        <div class="px-4 pb-3">
            <div class="flex items-center space-x-2">
                <button onclick="toggleSavedFilters()" class="px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg flex items-center space-x-1" title="Saved Filters">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                    <span class="hidden md:inline">Saved</span>
                </button>
                <div class="h-6 w-px bg-gray-300"></div>
                <div class="flex space-x-2 overflow-x-auto flex-1">
                <button onclick="filterByStatus('all')" data-status="all"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white whitespace-nowrap">
                    All
                </button>
                <button onclick="filterByStatus('new')" data-status="new"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    New
                </button>
                <button onclick="filterByStatus('open')" data-status="open"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    Open
                </button>
                <button onclick="filterByStatus('pending')" data-status="pending"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    Pending
                </button>
                <button onclick="filterByStatus('on-hold')" data-status="on-hold"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    On Hold
                </button>
                <button onclick="filterByStatus('solved')" data-status="solved"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    Solved
                </button>
                <button onclick="filterByStatus('closed')" data-status="closed"
                        class="status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap">
                    Closed
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Filters Display -->
    <div id="active-filters" class="hidden bg-blue-50 px-4 py-2 border-b border-blue-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 flex-wrap">
                <span class="text-sm text-blue-800 font-medium">Active filters:</span>
                <div id="filter-tags" class="flex items-center space-x-2 flex-wrap"></div>
            </div>
            <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-800">
                Clear all
            </button>
        </div>
    </div>

    <!-- Tickets Container -->
    <div class="flex-1 overflow-auto p-4">
        <!-- Loading State -->
        <div id="loading-state" class="hidden">
            <div class="flex justify-center items-center h-64">
                <div class="text-center">
                    <svg class="animate-spin h-8 w-8 mx-auto text-blue-600 mb-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <p class="text-gray-600">Loading tickets...</p>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Error loading tickets. Please try again.</p>
            </div>
        </div>

        <!-- Tickets Table -->
        <div id="tickets-container" class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Subject
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                From
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Assignee
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Priority
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Type
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tags
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Updated
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tickets-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Tickets will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div id="pagination-container" class="hidden bg-white rounded-lg shadow mt-4">
            <div class="px-6 py-4 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center text-sm text-gray-700">
                    <span id="pagination-info">Showing 1-20 of 100 tickets</span>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Previous button -->
                    <button id="prev-page-btn" onclick="changePage('prev')"
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </button>

                    <!-- Page numbers -->
                    <div id="page-numbers" class="flex items-center space-x-1">
                        <!-- Page buttons will be inserted here -->
                    </div>

                    <!-- Next button -->
                    <button id="next-page-btn" onclick="changePage('next')"
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- No Tickets State -->
        <div id="empty-state" class="hidden">
            <div class="bg-white rounded-lg shadow p-12">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No tickets found</h3>
                    <p class="text-gray-500">No tickets match your current filters.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include New Ticket Modal -->
{% include 'components/new_ticket_modal.html' %}

<!-- Save Filter Modal -->
<div id="save-filter-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Save Current Filter</h2>
        </div>

        <form id="save-filter-form" onsubmit="saveFilter(event)">
            <div class="px-6 py-4 space-y-4">
                <!-- Filter Name -->
                <div>
                    <label for="filter-name" class="block text-sm font-medium text-gray-700 mb-1">
                        Filter Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="filter-name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                           placeholder="e.g., High Priority Open Tickets">
                </div>

                <!-- Description -->
                <div>
                    <label for="filter-description" class="block text-sm font-medium text-gray-700 mb-1">
                        Description (Optional)
                    </label>
                    <textarea id="filter-description" name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Brief description of this filter"></textarea>
                </div>

                <!-- Filter Options -->
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="filter-is-favorite" name="is_favorite"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Mark as favorite (⭐ quick access)</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" id="filter-is-shared" name="is_shared"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Share with team</span>
                    </label>

                    <label class="flex items-center">
                        <input type="checkbox" id="filter-is-default" name="is_default"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Set as my default filter</span>
                    </label>
                </div>
            </div>

            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 rounded-b-lg">
                <button type="button" onclick="closeSaveFilterModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Save Filter
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentFilters = {
    status: 'all',
    search: '',
    assignee_ids: [],
    priorities: [],
    type_ids: [],
    organization_ids: [],
    tag_ids: [],
    created_from: '',
    created_to: ''
};

let currentPagination = {
    page: 1,
    per_page: 20,
    total: 0,
    pages: 0,
    has_next: false,
    has_prev: false
};

let allTickets = [];
let filterOptions = {};
let savedFilters = [];
let searchTimeout;
let refreshInterval = 'manual'; // 'manual', 30, 60, 300, 600 (seconds)
let refreshTimer = null;

// Status badge colors
const statusColors = {
    'new': 'bg-blue-100 text-blue-800',
    'open': 'bg-green-100 text-green-800',
    'pending': 'bg-yellow-100 text-yellow-800',
    'on-hold': 'bg-orange-100 text-orange-800',
    'solved': 'bg-purple-100 text-purple-800',
    'closed': 'bg-gray-100 text-gray-800',
    'archived': 'bg-gray-100 text-gray-600'
};

// Priority badge colors
const priorityColors = {
    1: 'bg-red-100 text-red-800',
    2: 'bg-red-100 text-red-800',
    3: 'bg-yellow-100 text-yellow-800',
    4: 'bg-green-100 text-green-800',
    5: 'bg-green-100 text-green-800'
};

// Priority labels
const priorityLabels = {
    1: 'Urgent',
    2: 'High',
    3: 'Normal',
    4: 'Low',
    5: 'Very Low'
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    loadSavedFilters();
    loadTickets();
});

// Toggle advanced search panel
function toggleAdvancedSearch() {
    const panel = document.getElementById('advanced-search-panel');
    const chevron = document.getElementById('search-chevron');

    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
    } else {
        panel.classList.add('hidden');
        chevron.style.transform = 'rotate(0)';
    }
}

// Load filter options from API
async function loadFilterOptions() {
    try {
        const response = await fetch('/api/filter-options');
        const data = await response.json();

        if (data.success) {
            filterOptions = data;

            // Populate assignee checkboxes
            const assigneeContainer = document.querySelector('#filter-assignee-dropdown .p-2');
            data.agents.forEach(agent => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${agent.id}" class="filter-assignee-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('assignee')">
                    <span class="ml-2 text-sm text-gray-700">${escapeHtml(agent.name)}</span>
                `;
                assigneeContainer.appendChild(label);
            });

            // Populate type checkboxes
            const typeContainer = document.getElementById('filter-type-options');
            data.ticket_types.forEach(type => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${type.id}" class="filter-type-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('type')">
                    <span class="ml-2 text-sm text-gray-700">${escapeHtml(type.name)}</span>
                `;
                typeContainer.appendChild(label);
            });

            // Populate organization checkboxes
            const orgContainer = document.getElementById('filter-organization-options');
            data.organizations.forEach(org => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${org.id}" class="filter-organization-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('organization')">
                    <span class="ml-2 text-sm text-gray-700">${escapeHtml(org.name)}</span>
                `;
                orgContainer.appendChild(label);
            });

            // Populate tag checkboxes
            const tagContainer = document.getElementById('filter-tag-options');
            data.tags.forEach(tag => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${tag.id}" class="filter-tag-option rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="updateMultiSelectFilter('tag')">
                    <span class="ml-2 text-sm text-gray-700">${escapeHtml(tag.name)}</span>
                `;
                tagContainer.appendChild(label);
            });
        }
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

// Debounce search input
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        applyFilters();
    }, 500);
}

// Apply filters
function applyFilters() {
    currentFilters.search = document.getElementById('search-text').value;
    currentFilters.created_from = document.getElementById('filter-date-from').value;
    currentFilters.created_to = document.getElementById('filter-date-to').value;

    updateActiveFilters();
    loadTickets();
}

// Update active filters display
function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    const tagsContainer = document.getElementById('filter-tags');
    tagsContainer.innerHTML = '';

    let hasActiveFilters = false;

    // Check each filter
    if (currentFilters.search) {
        hasActiveFilters = true;
        addFilterTag(`Search: ${currentFilters.search}`, () => {
            document.getElementById('search-text').value = '';
            currentFilters.search = '';
            applyFilters();
        });
    }

    if (currentFilters.assignee_ids && currentFilters.assignee_ids.length > 0) {
        hasActiveFilters = true;
        currentFilters.assignee_ids.forEach(id => {
            const name = id === 'unassigned' ? 'Unassigned' :
                filterOptions.agents?.find(a => a.id == id)?.name || id;
            addFilterTag(`Assignee: ${name}`, () => {
                const checkbox = document.querySelector(`.filter-assignee-option[value="${id}"]`);
                if (checkbox) checkbox.checked = false;
                updateMultiSelectFilter('assignee');
            });
        });
    }

    if (currentFilters.priorities && currentFilters.priorities.length > 0) {
        hasActiveFilters = true;
        currentFilters.priorities.forEach(priority => {
            addFilterTag(`Priority: ${priorityLabels[priority]}`, () => {
                const checkbox = document.querySelector(`.filter-priority-option[value="${priority}"]`);
                if (checkbox) checkbox.checked = false;
                updateMultiSelectFilter('priority');
            });
        });
    }

    if (currentFilters.type_ids && currentFilters.type_ids.length > 0) {
        hasActiveFilters = true;
        currentFilters.type_ids.forEach(id => {
            const name = filterOptions.ticket_types?.find(t => t.id == id)?.name || id;
            addFilterTag(`Type: ${name}`, () => {
                const checkbox = document.querySelector(`.filter-type-option[value="${id}"]`);
                if (checkbox) checkbox.checked = false;
                updateMultiSelectFilter('type');
            });
        });
    }

    if (currentFilters.organization_ids && currentFilters.organization_ids.length > 0) {
        hasActiveFilters = true;
        currentFilters.organization_ids.forEach(id => {
            const name = filterOptions.organizations?.find(o => o.id == id)?.name || id;
            addFilterTag(`Org: ${name}`, () => {
                const checkbox = document.querySelector(`.filter-organization-option[value="${id}"]`);
                if (checkbox) checkbox.checked = false;
                updateMultiSelectFilter('organization');
            });
        });
    }

    if (currentFilters.tag_ids && currentFilters.tag_ids.length > 0) {
        hasActiveFilters = true;
        currentFilters.tag_ids.forEach(id => {
            const name = filterOptions.tags?.find(t => t.id == id)?.name || id;
            addFilterTag(`Tag: ${name}`, () => {
                const checkbox = document.querySelector(`.filter-tag-option[value="${id}"]`);
                if (checkbox) checkbox.checked = false;
                updateMultiSelectFilter('tag');
            });
        });
    }

    if (currentFilters.status !== 'all') {
        hasActiveFilters = true;
        addFilterTag(`Status: ${currentFilters.status}`, () => {
            filterByStatus('all');
        });
    }

    // Show/hide active filters container
    if (hasActiveFilters) {
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

// Add filter tag
function addFilterTag(label, onRemove) {
    const tagsContainer = document.getElementById('filter-tags');
    const tag = document.createElement('span');
    tag.className = 'inline-flex items-center px-2 py-1 rounded-md text-xs bg-blue-100 text-blue-800';
    tag.innerHTML = `
        ${label}
        <button onclick="event.preventDefault()" class="ml-1 hover:text-blue-900">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
        </button>
    `;
    tag.querySelector('button').onclick = onRemove;
    tagsContainer.appendChild(tag);
}

// Clear all filters
function clearFilters() {
    currentFilters = {
        status: 'all',
        search: '',
        assignee_ids: [],
        priorities: [],
        type_ids: [],
        organization_ids: [],
        tag_ids: [],
        created_from: '',
        created_to: ''
    };

    // Reset form fields
    document.getElementById('search-text').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';

    // Reset multi-select checkboxes
    document.querySelectorAll('.filter-assignee-option').forEach(cb => cb.checked = false);
    document.querySelectorAll('.filter-priority-option').forEach(cb => cb.checked = false);
    document.querySelectorAll('.filter-type-option').forEach(cb => cb.checked = false);
    document.querySelectorAll('.filter-organization-option').forEach(cb => cb.checked = false);
    document.querySelectorAll('.filter-tag-option').forEach(cb => cb.checked = false);

    // Update labels
    updateMultiSelectLabel('assignee');
    updateMultiSelectLabel('priority');
    updateMultiSelectLabel('type');
    updateMultiSelectLabel('organization');
    updateMultiSelectLabel('tag');

    // Reset status filter
    filterByStatus('all');

    updateActiveFilters();
    loadTickets();
}

// Toggle multi-select dropdown
function toggleMultiSelectDropdown(filterType) {
    const dropdown = document.getElementById(`filter-${filterType}-dropdown`);
    const isHidden = dropdown.classList.contains('hidden');

    // Close all dropdowns first
    document.querySelectorAll('[id$="-dropdown"]').forEach(dd => dd.classList.add('hidden'));

    // Toggle the clicked dropdown
    if (isHidden) {
        dropdown.classList.remove('hidden');

        // Close dropdown when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest(`#filter-${filterType}-dropdown`) && !e.target.closest(`[onclick*="toggleMultiSelectDropdown('${filterType}')"]`)) {
                    dropdown.classList.add('hidden');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }, 100);
    }
}

// Update multi-select filter
function updateMultiSelectFilter(filterType) {
    const checkboxes = document.querySelectorAll(`.filter-${filterType}-option:checked`);
    const values = Array.from(checkboxes).map(cb => cb.value);

    // Update currentFilters based on filter type
    switch(filterType) {
        case 'assignee':
            currentFilters.assignee_ids = values;
            break;
        case 'priority':
            currentFilters.priorities = values;
            break;
        case 'type':
            currentFilters.type_ids = values;
            break;
        case 'organization':
            currentFilters.organization_ids = values;
            break;
        case 'tag':
            currentFilters.tag_ids = values;
            break;
    }

    // Update label
    updateMultiSelectLabel(filterType);

    // Apply filters
    applyFilters();
}

// Update multi-select label
function updateMultiSelectLabel(filterType) {
    const label = document.getElementById(`filter-${filterType}-label`);
    let values = [];
    let allLabel = '';

    switch(filterType) {
        case 'assignee':
            values = currentFilters.assignee_ids;
            allLabel = 'All Assignees';
            break;
        case 'priority':
            values = currentFilters.priorities;
            allLabel = 'All Priorities';
            break;
        case 'type':
            values = currentFilters.type_ids;
            allLabel = 'All Types';
            break;
        case 'organization':
            values = currentFilters.organization_ids;
            allLabel = 'All Organizations';
            break;
        case 'tag':
            values = currentFilters.tag_ids;
            allLabel = 'All Tags';
            break;
    }

    if (values.length === 0) {
        label.textContent = allLabel;
    } else if (values.length === 1) {
        // Show single selection
        const checkbox = document.querySelector(`.filter-${filterType}-option[value="${values[0]}"]`);
        if (checkbox) {
            const text = checkbox.parentElement.textContent.trim();
            label.textContent = text;
        } else {
            label.textContent = `1 selected`;
        }
    } else {
        label.textContent = `${values.length} selected`;
    }
}

// Filter by status
function filterByStatus(status) {
    currentFilters.status = status;

    // Update button styles
    document.querySelectorAll('.status-filter').forEach(btn => {
        if (btn.dataset.status === status) {
            btn.className = 'status-filter px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white whitespace-nowrap';
        } else {
            btn.className = 'status-filter px-4 py-2 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 whitespace-nowrap';
        }
    });

    updateActiveFilters();
    loadTickets();
}

// Load tickets from API
async function loadTickets(resetPage = true) {
    // Reset to page 1 when filters change, unless explicitly told not to
    if (resetPage) {
        currentPagination.page = 1;
    }

    // Show loading state
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('tickets-container').classList.add('hidden');
    document.getElementById('pagination-container').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');

    try {
        // Build query string
        const params = new URLSearchParams();

        // Add pagination params
        params.append('page', currentPagination.page);
        params.append('per_page', currentPagination.per_page);

        if (currentFilters.status !== 'all') params.append('status', currentFilters.status);
        if (currentFilters.search) params.append('search', currentFilters.search);

        // Multi-select filters - append multiple values
        if (currentFilters.assignee_ids && currentFilters.assignee_ids.length > 0) {
            currentFilters.assignee_ids.forEach(id => params.append('assignee_ids', id));
        }
        if (currentFilters.priorities && currentFilters.priorities.length > 0) {
            currentFilters.priorities.forEach(p => params.append('priorities', p));
        }
        if (currentFilters.type_ids && currentFilters.type_ids.length > 0) {
            currentFilters.type_ids.forEach(id => params.append('type_ids', id));
        }
        if (currentFilters.organization_ids && currentFilters.organization_ids.length > 0) {
            currentFilters.organization_ids.forEach(id => params.append('organization_ids', id));
        }
        if (currentFilters.tag_ids && currentFilters.tag_ids.length > 0) {
            currentFilters.tag_ids.forEach(id => params.append('tag_ids', id));
        }

        if (currentFilters.created_from) params.append('created_from', currentFilters.created_from);
        if (currentFilters.created_to) params.append('created_to', currentFilters.created_to);

        const response = await fetch('/api/tickets/search?' + params.toString());
        if (!response.ok) throw new Error('Failed to fetch tickets');

        const data = await response.json();
        allTickets = data.tickets || [];

        // Update pagination info
        if (data.pagination) {
            currentPagination = { ...currentPagination, ...data.pagination };
        }

        // Update ticket count
        document.getElementById('ticket-count').textContent = `${currentPagination.total || allTickets.length} ticket${(currentPagination.total || allTickets.length) !== 1 ? 's' : ''}`;

        // Render tickets and pagination
        renderTickets(allTickets);
        renderPagination();

    } catch (error) {
        console.error('Error loading tickets:', error);
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
    }
}

// Render tickets in table
function renderTickets(tickets) {
    const tbody = document.getElementById('tickets-tbody');
    tbody.innerHTML = '';

    // Hide loading state
    document.getElementById('loading-state').classList.add('hidden');

    if (tickets.length === 0) {
        // Show empty state
        document.getElementById('tickets-container').classList.add('hidden');
        document.getElementById('pagination-container').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        return;
    }

    // Show tickets container
    document.getElementById('tickets-container').classList.remove('hidden');
    document.getElementById('empty-state').classList.add('hidden');

    // Create rows for each ticket
    tickets.forEach(ticket => {
        const row = document.createElement('tr');
        // Add visual distinction for unread tickets
        const baseClasses = 'cursor-pointer transition-colors duration-150';
        const unreadClasses = ticket.is_read
            ? 'hover:bg-gray-50'
            : 'bg-blue-50 hover:bg-blue-100 border-l-4 border-blue-500 font-medium';
        row.className = `${baseClasses} ${unreadClasses}`;
        row.onclick = () => openTicket(ticket.id);

        // Format date
        const updatedDate = ticket.updated_at ? new Date(ticket.updated_at) : new Date(ticket.created_at);
        const dateStr = updatedDate.toLocaleDateString() + ' ' + updatedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        // Get type name
        const typeName = filterOptions.ticket_types?.find(t => t.id === ticket.type_id)?.name || '-';

        // Render tags
        let tagsHtml = '';
        if (ticket.tags && ticket.tags.length > 0) {
            const displayTags = ticket.tags.slice(0, 3);
            tagsHtml = displayTags.map(tag => {
                const tagColor = tag.color || '#6B7280';
                return `<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium border"
                              style="background-color: ${tagColor}10; color: ${tagColor}; border-color: ${tagColor}25;">
                    ${escapeHtml(tag.name)}
                </span>`;
            }).join(' ');

            if (ticket.tags.length > 3) {
                tagsHtml += ` <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-gray-50 text-gray-500 border border-gray-200">+${ticket.tags.length - 3}</span>`;
            }
        } else {
            tagsHtml = '<span class="text-gray-400 text-xs">-</span>';
        }

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColors[ticket.status] || 'bg-gray-100 text-gray-800'}">
                    ${ticket.status_label || ticket.status}
                </span>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center">
                    ${!ticket.is_read ? `<div class="w-2 h-2 bg-blue-500 rounded-full mr-2 flex-shrink-0" title="Unread"></div>` : ''}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 ${!ticket.is_read ? 'font-semibold' : ''}">${escapeHtml(ticket.subject)}</div>
                        <div class="text-sm text-gray-500">#${ticket.ticket_number}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900">${escapeHtml(ticket.sender_name || 'Unknown')}</div>
                <div class="text-sm text-gray-500">${escapeHtml(ticket.sender_email)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${ticket.assignee ? escapeHtml(ticket.assignee.full_name) : '<span class="text-gray-400">Unassigned</span>'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${priorityColors[ticket.priority] || 'bg-gray-100 text-gray-800'}">
                    ${priorityLabels[ticket.priority] || 'Normal'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${typeName}
            </td>
            <td class="px-6 py-4">
                <div class="flex flex-wrap gap-1">
                    ${tagsHtml}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${dateStr}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                    <button onclick="event.stopPropagation(); openTicket(${ticket.id})"
                            class="inline-flex items-center justify-center w-8 h-8 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-full transition-colors duration-200"
                            title="View ticket">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                    ${!ticket.is_read ? `
                        <button onclick="event.stopPropagation(); markAsRead(${ticket.id})"
                                class="inline-flex items-center justify-center w-8 h-8 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-full transition-colors duration-200"
                                title="Mark as read">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                    ` : `
                        <button onclick="event.stopPropagation(); markAsUnread(${ticket.id})"
                                class="inline-flex items-center justify-center w-8 h-8 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-full transition-colors duration-200"
                                title="Mark as unread">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L5.636 5.636"></path>
                            </svg>
                        </button>
                    `}
                    <button onclick="event.stopPropagation(); deleteTicket(${ticket.id})"
                            class="inline-flex items-center justify-center w-8 h-8 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-full transition-colors duration-200"
                            title="Delete ticket">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

// Open ticket detail
function openTicket(ticketId) {
    window.location.href = `/ticket/${ticketId}`;
}

// Mark ticket as read
async function markAsRead(ticketId) {
    try {
        const response = await fetch(`/api/ticket/${ticketId}/mark-read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Reload tickets to show updated status
            loadTickets();
        }
    } catch (error) {
        console.error('Error marking ticket as read:', error);
    }
}

// Mark ticket as unread
async function markAsUnread(ticketId) {
    try {
        const response = await fetch(`/api/ticket/${ticketId}/mark-unread`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Reload tickets to show updated status
            loadTickets();
        }
    } catch (error) {
        console.error('Error marking ticket as unread:', error);
    }
}

// Delete ticket with confirmation
async function deleteTicket(ticketId) {
    if (!confirm('Are you sure you want to delete this ticket? This action can be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/ticket/${ticketId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // Show success message
            alert('Ticket deleted successfully');
            // Reload tickets to show updated list
            loadTickets();
        } else {
            alert('Error deleting ticket: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting ticket:', error);
        alert('Error deleting ticket: ' + error.message);
    }
}

// Render pagination controls
function renderPagination() {
    const paginationContainer = document.getElementById('pagination-container');
    const paginationInfo = document.getElementById('pagination-info');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const pageNumbers = document.getElementById('page-numbers');

    // Only show pagination if there are multiple pages
    if (currentPagination.pages <= 1) {
        paginationContainer.classList.add('hidden');
        return;
    }

    // Show pagination container
    paginationContainer.classList.remove('hidden');

    // Update pagination info
    const startItem = ((currentPagination.page - 1) * currentPagination.per_page) + 1;
    const endItem = Math.min(currentPagination.page * currentPagination.per_page, currentPagination.total);
    paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${currentPagination.total} tickets`;

    // Update prev/next buttons
    prevBtn.disabled = !currentPagination.has_prev;
    nextBtn.disabled = !currentPagination.has_next;

    // Generate page numbers
    pageNumbers.innerHTML = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPagination.page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(currentPagination.pages, startPage + maxVisiblePages - 1);

    // Adjust start page if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // Add first page and ellipsis if needed
    if (startPage > 1) {
        addPageButton(1);
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-sm text-gray-500';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
        }
    }

    // Add page buttons
    for (let page = startPage; page <= endPage; page++) {
        addPageButton(page);
    }

    // Add last page and ellipsis if needed
    if (endPage < currentPagination.pages) {
        if (endPage < currentPagination.pages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-2 py-1 text-sm text-gray-500';
            ellipsis.textContent = '...';
            pageNumbers.appendChild(ellipsis);
        }
        addPageButton(currentPagination.pages);
    }
}

// Add page button helper
function addPageButton(pageNum) {
    const pageNumbers = document.getElementById('page-numbers');
    const button = document.createElement('button');
    const isActive = pageNum === currentPagination.page;

    button.className = isActive
        ? 'px-3 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-300 rounded-md'
        : 'px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700';

    button.textContent = pageNum;
    button.onclick = () => changePage(pageNum);
    pageNumbers.appendChild(button);
}

// Change page function
function changePage(direction) {
    if (typeof direction === 'number') {
        currentPagination.page = direction;
    } else if (direction === 'prev' && currentPagination.has_prev) {
        currentPagination.page--;
    } else if (direction === 'next' && currentPagination.has_next) {
        currentPagination.page++;
    } else {
        return; // Invalid direction or no more pages
    }

    // Load tickets without resetting page
    loadTickets(false);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Toggle refresh dropdown
function toggleRefreshDropdown() {
    const dropdown = document.getElementById('refresh-dropdown-menu');
    dropdown.classList.toggle('hidden');
}

// Set refresh interval
function setRefreshInterval(interval) {
    refreshInterval = interval;

    // Clear existing timer
    if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
    }

    // If manual, just refresh once and close dropdown
    if (interval === 'manual') {
        loadTickets();
        toggleRefreshDropdown();
        return;
    }

    // Set up auto-refresh timer
    refreshTimer = setInterval(() => {
        loadTickets(false); // Don't reset page on auto-refresh
    }, interval * 1000);

    // Close dropdown
    toggleRefreshDropdown();

    // Refresh immediately
    loadTickets();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const container = document.getElementById('refresh-dropdown-container');
    const dropdown = document.getElementById('refresh-dropdown-menu');

    if (container && dropdown && !container.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// New Ticket Modal Functions
function openNewTicketModal() {
    // Populate form options
    populateTicketFormOptions();

    // Show modal
    document.getElementById('new-ticket-modal').classList.remove('hidden');

    // Focus on first input
    document.getElementById('ticket-subject').focus();
}

function closeNewTicketModal() {
    // Hide modal
    document.getElementById('new-ticket-modal').classList.add('hidden');

    // Reset form
    document.getElementById('new-ticket-form').reset();

    // Hide advanced fields
    document.getElementById('advanced-fields').classList.add('hidden');
    document.getElementById('advanced-chevron').style.transform = 'rotate(0)';

    // Hide loading state
    document.getElementById('ticket-form-loading').classList.add('hidden');
}

function toggleAdvancedFields() {
    const advancedFields = document.getElementById('advanced-fields');
    const chevron = document.getElementById('advanced-chevron');

    if (advancedFields.classList.contains('hidden')) {
        advancedFields.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
    } else {
        advancedFields.classList.add('hidden');
        chevron.style.transform = 'rotate(0)';
    }
}

function populateTicketFormOptions() {
    // Populate assignee options
    const assigneeSelect = document.getElementById('ticket-assignee');
    assigneeSelect.innerHTML = '<option value="">Unassigned</option>';

    if (filterOptions.agents) {
        filterOptions.agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.name;
            assigneeSelect.appendChild(option);
        });
    }

    // Populate organization options (now mandatory)
    const orgSelect = document.getElementById('ticket-organization');
    orgSelect.innerHTML = '<option value="">Select organization</option>';

    if (filterOptions.organizations) {
        filterOptions.organizations.forEach(org => {
            const option = document.createElement('option');
            option.value = org.id;
            option.textContent = org.name;
            orgSelect.appendChild(option);
        });
    }

    // Populate ticket type options
    const typeSelect = document.getElementById('ticket-type');
    typeSelect.innerHTML = '<option value="">Select type</option>';

    if (filterOptions.ticket_types) {
        filterOptions.ticket_types.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            typeSelect.appendChild(option);
        });
    }
}

async function createTicket(event) {
    event.preventDefault();

    const form = document.getElementById('new-ticket-form');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('create-ticket-btn');
    const loadingDiv = document.getElementById('ticket-form-loading');
    const fileInput = document.getElementById('ticket-attachments');

    // Show loading state
    loadingDiv.classList.remove('hidden');
    submitBtn.disabled = true;

    try {
        // Check if there are file attachments
        const hasAttachments = fileInput && fileInput.files && fileInput.files.length > 0;

        let requestOptions;

        if (hasAttachments) {
            // Send as multipart form data to support file uploads
            requestOptions = {
                method: 'POST',
                body: formData
            };
        } else {
            // Send as JSON for backward compatibility
            const ticketData = {
                subject: formData.get('subject'),
                sender_email: formData.get('sender_email'),
                sender_name: formData.get('sender_name'),
                content_text: formData.get('content_text'),
                priority: parseInt(formData.get('priority')),
                assignee_id: formData.get('assignee_id') || null,
                organization_id: formData.get('organization_id') || null,
                type_id: formData.get('type_id') || null,
                cc_emails: formData.get('cc_emails'),
                internal_notes: formData.get('internal_notes')
            };

            // Remove empty values
            Object.keys(ticketData).forEach(key => {
                if (ticketData[key] === '' || ticketData[key] === null) {
                    delete ticketData[key];
                }
            });

            requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(ticketData)
            };
        }

        const response = await fetch('/api/tickets/create', requestOptions);
        const result = await response.json();

        if (result.success) {
            // Show success message
            alert(`Ticket #${result.ticket_number} created successfully!`);

            // Close modal
            closeNewTicketModal();

            // Refresh tickets list
            loadTickets();
        } else {
            throw new Error(result.message || 'Failed to create ticket');
        }

    } catch (error) {
        console.error('Error creating ticket:', error);
        alert('Error creating ticket: ' + error.message);
    } finally {
        // Hide loading state
        loadingDiv.classList.add('hidden');
        submitBtn.disabled = false;
    }
}

// Handle file attachments
function handleFileAttachments() {
    const fileInput = document.getElementById('ticket-attachments');
    const attachmentList = document.getElementById('attachment-list');

    if (!fileInput) return;

    fileInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        attachmentList.innerHTML = '';

        if (files.length === 0) {
            attachmentList.classList.add('hidden');
            return;
        }

        // Validate file count
        if (files.length > 10) {
            alert('Maximum 10 files allowed. Please select fewer files.');
            event.target.value = '';
            return;
        }

        // Validate file sizes
        const maxSize = 5 * 1024 * 1024; // 5MB
        const oversizedFiles = files.filter(file => file.size > maxSize);
        if (oversizedFiles.length > 0) {
            alert(`File(s) too large: ${oversizedFiles.map(f => f.name).join(', ')}. Maximum size is 5MB per file.`);
            event.target.value = '';
            return;
        }

        // Display selected files
        attachmentList.classList.remove('hidden');
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded text-sm';
            fileItem.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                    <span>${file.name}</span>
                    <span class="ml-2 text-gray-500">(${formatFileSize(file.size)})</span>
                </div>
                <button type="button" onclick="removeAttachment(${index})" class="text-red-600 hover:text-red-800">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            attachmentList.appendChild(fileItem);
        });
    });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeAttachment(index) {
    const fileInput = document.getElementById('ticket-attachments');
    const dt = new DataTransfer();
    const files = Array.from(fileInput.files);

    // Add all files except the one to remove
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });

    // Update file input
    fileInput.files = dt.files;

    // Trigger change event to refresh the display
    fileInput.dispatchEvent(new Event('change'));
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('new-ticket-modal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeNewTicketModal();
            }
        });
    }

    // Initialize file attachment handling
    handleFileAttachments();

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeNewTicketModal();
        }
        // Close save filter modal with Escape key
        const saveFilterModal = document.getElementById('save-filter-modal');
        if (event.key === 'Escape' && saveFilterModal && !saveFilterModal.classList.contains('hidden')) {
            closeSaveFilterModal();
        }
    });
});

// ============ Saved Filters Functions ============

// Load saved filters from API
async function loadSavedFilters() {
    try {
        const response = await fetch('/api/saved-filters');
        const data = await response.json();

        if (data.success) {
            savedFilters = data.filters || [];
            renderSavedFilters();
        }
    } catch (error) {
        console.error('Error loading saved filters:', error);
    }
}

// Render saved filters list
function renderSavedFilters() {
    const container = document.getElementById('saved-filters-list');
    if (!container) return;

    container.innerHTML = '';

    if (savedFilters.length === 0) {
        container.innerHTML = `
            <p class="text-sm text-gray-500 text-center py-4">
                No saved filters yet. Apply some filters and click "Save Filter" to create one.
            </p>
        `;
        return;
    }

    // Sort: favorites first, then by sort order
    const sortedFilters = [...savedFilters].sort((a, b) => {
        if (a.is_favorite && !b.is_favorite) return -1;
        if (!a.is_favorite && b.is_favorite) return 1;
        return a.sort_order - b.sort_order;
    });

    sortedFilters.forEach(filter => {
        const filterItem = document.createElement('div');
        filterItem.className = 'flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors group';

        const badges = [];
        if (filter.is_default) badges.push('<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full">Default</span>');
        if (filter.is_favorite) badges.push('<span class="text-xs">⭐</span>');
        if (filter.is_shared) badges.push('<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full">Shared</span>');

        filterItem.innerHTML = `
            <div class="flex-1 min-w-0" onclick="applySavedFilter(${filter.id})">
                <div class="flex items-center space-x-2">
                    <p class="text-sm font-medium text-gray-900 truncate">${escapeHtml(filter.name)}</p>
                    ${badges.join('')}
                </div>
                ${filter.description ? `<p class="text-xs text-gray-500 truncate mt-1">${escapeHtml(filter.description)}</p>` : ''}
            </div>
            <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="event.stopPropagation(); toggleFilterFavorite(${filter.id}, ${!filter.is_favorite})"
                        class="p-1 hover:bg-gray-200 rounded" title="${filter.is_favorite ? 'Remove from favorites' : 'Add to favorites'}">
                    <svg class="w-4 h-4 ${filter.is_favorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                </button>
                <button onclick="event.stopPropagation(); deleteSavedFilter(${filter.id})"
                        class="p-1 hover:bg-red-100 rounded" title="Delete filter">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;

        container.appendChild(filterItem);
    });
}

// Toggle saved filters panel
function toggleSavedFilters() {
    const panel = document.getElementById('saved-filters-panel');
    panel.classList.toggle('hidden');
}

// Open save filter modal
function openSaveFilterModal() {
    // Check if any filters are applied
    const hasFilters = currentFilters.status !== 'all' || currentFilters.search ||
                      currentFilters.assignee_id || currentFilters.priority ||
                      currentFilters.type_id || currentFilters.organization_id ||
                      currentFilters.tag_id || currentFilters.created_from || currentFilters.created_to;

    if (!hasFilters) {
        alert('Please apply some filters before saving');
        return;
    }

    document.getElementById('save-filter-modal').classList.remove('hidden');
    document.getElementById('filter-name').focus();
}

// Close save filter modal
function closeSaveFilterModal() {
    document.getElementById('save-filter-modal').classList.add('hidden');
    document.getElementById('save-filter-form').reset();
}

// Save filter
async function saveFilter(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const filterData = {
        name: formData.get('name'),
        description: formData.get('description'),
        criteria: { ...currentFilters },
        is_favorite: formData.get('is_favorite') === 'on',
        is_shared: formData.get('is_shared') === 'on',
        is_default: formData.get('is_default') === 'on'
    };

    try {
        const response = await fetch('/api/saved-filters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(filterData)
        });

        const result = await response.json();

        if (result.success) {
            alert('Filter saved successfully!');
            closeSaveFilterModal();
            await loadSavedFilters();
        } else {
            alert('Error saving filter: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving filter:', error);
        alert('Error saving filter: ' + error.message);
    }
}

// Apply saved filter
async function applySavedFilter(filterId) {
    const filter = savedFilters.find(f => f.id === filterId);
    if (!filter) return;

    const criteria = filter.criteria;

    // Apply all criteria to current filters
    currentFilters = {
        status: criteria.status || 'all',
        search: criteria.search || '',
        assignee_id: criteria.assignee_id || '',
        priority: criteria.priority || '',
        type_id: criteria.type_id || '',
        organization_id: criteria.organization_id || '',
        tag_id: criteria.tag_id || '',
        created_from: criteria.created_from || '',
        created_to: criteria.created_to || ''
    };

    // Update form fields
    document.getElementById('search-text').value = currentFilters.search;
    document.getElementById('filter-assignee').value = currentFilters.assignee_id;
    document.getElementById('filter-priority').value = currentFilters.priority;
    document.getElementById('filter-type').value = currentFilters.type_id;
    document.getElementById('filter-organization').value = currentFilters.organization_id;
    document.getElementById('filter-tag').value = currentFilters.tag_id;
    document.getElementById('filter-date-from').value = currentFilters.created_from;
    document.getElementById('filter-date-to').value = currentFilters.created_to;

    // Update status filter
    filterByStatus(currentFilters.status);

    // Show advanced filters if any advanced criteria is set
    const hasAdvancedFilters = currentFilters.assignee_id || currentFilters.priority ||
                               currentFilters.type_id || currentFilters.organization_id ||
                               currentFilters.tag_id || currentFilters.created_from || currentFilters.created_to;
    if (hasAdvancedFilters) {
        const panel = document.getElementById('advanced-search-panel');
        if (panel.classList.contains('hidden')) {
            toggleAdvancedSearch();
        }
    }

    updateActiveFilters();
    loadTickets();

    // Close saved filters panel
    toggleSavedFilters();
}

// Toggle filter favorite status
async function toggleFilterFavorite(filterId, isFavorite) {
    try {
        const response = await fetch(`/api/saved-filters/${filterId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_favorite: isFavorite })
        });

        const result = await response.json();

        if (result.success) {
            await loadSavedFilters();
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
    }
}

// Delete saved filter
async function deleteSavedFilter(filterId) {
    if (!confirm('Are you sure you want to delete this saved filter?')) {
        return;
    }

    try {
        const response = await fetch(`/api/saved-filters/${filterId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            await loadSavedFilters();
        } else {
            alert('Error deleting filter: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting filter:', error);
        alert('Error deleting filter: ' + error.message);
    }
}
</script>
{% endblock %}