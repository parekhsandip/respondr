{% extends "base.html" %}

{% block title %}{{ ticket.subject }} - Respondr{% endblock %}

{% block content %}
<!-- Modern Ticket View with Enhanced UX -->
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50">

    <!-- Mobile Header (Sticky) -->
    <div class="lg:hidden sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100">
        <!-- Ticket Number and Status Bar -->
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="history.back()" class="p-1.5 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <div>
                        <div class="text-xs font-mono text-gray-500">#{{ ticket.ticket_number }}</div>
                        <div class="text-sm font-medium text-gray-900 truncate max-w-[200px]">{{ ticket.subject }}</div>
                    </div>
                </div>
                <button onclick="toggleMobileMenu()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Tabs -->
        <div class="flex border-t border-gray-100">
            <button onclick="switchTab('conversation')" data-tab="conversation"
                    class="mobile-tab flex-1 py-3 text-sm font-medium text-blue-600 border-b-2 border-blue-600 bg-blue-50/50 transition-all">
                Conversation
            </button>
            <button onclick="switchTab('details')" data-tab="details"
                    class="mobile-tab flex-1 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-900 transition-all">
                Details
            </button>
            <button onclick="switchTab('activity')" data-tab="activity"
                    class="mobile-tab flex-1 py-3 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-900 transition-all">
                Activity
            </button>
        </div>
    </div>

    <!-- Desktop Layout Container -->
    <div class="flex h-[calc(100vh-4rem)] lg:h-screen max-w-full overflow-hidden">

        <!-- Sidebar (Desktop & Tablet) -->
        <aside class="hidden lg:flex w-80 xl:w-96 bg-white border-r border-gray-200 flex-col flex-shrink-0">
            <!-- Sidebar Header -->
            <div class="px-6 py-5 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xs font-mono text-gray-500 mb-1">#{{ ticket.ticket_number }}</div>
                        <h2 class="text-lg font-semibold text-gray-900">Ticket Details</h2>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Status Badge -->
                        {% set status_colors = {
                            'new': 'bg-blue-100 text-blue-700 ring-blue-600/20',
                            'open': 'bg-emerald-100 text-emerald-700 ring-emerald-600/20',
                            'pending': 'bg-amber-100 text-amber-700 ring-amber-600/20',
                            'closed': 'bg-gray-100 text-gray-700 ring-gray-600/20',
                            'archived': 'bg-purple-100 text-purple-700 ring-purple-600/20'
                        } %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ring-1 ring-inset {{ status_colors.get(ticket.status, 'bg-gray-100 text-gray-700 ring-gray-600/20') }}">
                            {{ ticket.status|title }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Scrollable Sidebar Content -->
            <div class="flex-1 overflow-y-auto">
                <!-- Quick Actions -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Quick Actions</h3>
                    <div class="space-y-3">
                        <!-- Status and Priority Row -->
                        <div class="flex items-center gap-2">
                            <div class="flex-1">
                                <label class="text-xs text-gray-600 block mb-1">Status</label>
                                <select id="status-select"
                                    hx-post="{{ url_for('update_ticket_status', ticket_id=ticket.id) }}"
                                    hx-trigger="change"
                                    hx-swap="none"
                                    hx-on:htmx:after-request="showToast('Status updated', 'success')"
                                    name="status"
                                    class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="new" {{ 'selected' if ticket.status == 'new' }}>New</option>
                                <option value="open" {{ 'selected' if ticket.status == 'open' }}>Open</option>
                                <option value="pending" {{ 'selected' if ticket.status == 'pending' }}>Pending</option>
                                <option value="closed" {{ 'selected' if ticket.status == 'closed' }}>Closed</option>
                                <option value="archived" {{ 'selected' if ticket.status == 'archived' }}>Archived</option>
                            </select>
                            </div>

                            <div class="flex-1">
                                <label class="text-xs text-gray-600 block mb-1">Priority</label>
                                <select id="priority-select"
                                    hx-post="{{ url_for('update_ticket_priority', ticket_id=ticket.id) }}"
                                    hx-trigger="change"
                                    hx-swap="none"
                                    hx-on:htmx:after-request="showToast('Priority updated', 'success')"
                                    name="priority"
                                    class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                {% for i in range(1, 6) %}
                                    <option value="{{ i }}" {{ 'selected' if ticket.priority == i }}>
                                        {% if i == 1 %}ðŸ”´ Urgent
                                        {% elif i == 2 %}ðŸŸ  High
                                        {% elif i == 3 %}ðŸŸ¡ Normal
                                        {% elif i == 4 %}ðŸ”µ Low
                                        {% else %}âšª Lowest{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            </div>
                        </div>

                        <!-- Type Field -->
                        <div>
                            <label class="text-xs text-gray-600 block mb-1">Type</label>
                            <select id="type-select"
                                hx-post="{{ url_for('update_ticket_type_assignment', ticket_id=ticket.id) }}"
                                hx-trigger="change"
                                hx-swap="none"
                                hx-on:htmx:after-request="showToast('Type updated', 'success')"
                                name="type_id"
                                class="w-full px-3 py-1.5 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="">No Type</option>
                                {% for ticket_type in ticket_types %}
                                    <option value="{{ ticket_type.id }}" {{ 'selected' if ticket.type_id == ticket_type.id }}>
                                        {{ ticket_type.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Card -->
                <div class="px-6 py-4 space-y-4">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Customer
                        </h3>
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold">
                                    {{ (ticket.sender_name or ticket.sender_email)[0].upper() }}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">{{ ticket.sender_name or 'Unknown' }}</p>
                                <p class="text-sm text-gray-600 truncate">{{ ticket.sender_email }}</p>
                                {% if ticket.organization %}
                                    <p class="text-xs text-blue-600 mt-1">{{ ticket.organization.name }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Card -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Assignment
                        </h3>
                        <select hx-post="{{ url_for('assign_ticket', ticket_id=ticket.id) }}"
                                hx-trigger="change"
                                hx-swap="none"
                                hx-on:htmx:after-request="showToast('Assignment updated', 'success')"
                                name="assignee_id"
                                class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all">
                            <option value="">Unassigned</option>
                            {% for agent in agents %}
                                <option value="{{ agent.id }}" {{ 'selected' if ticket.assignee_id == agent.id }}>
                                    {{ agent.full_name }}
                                </option>
                            {% endfor %}
                        </select>

                        {% if ticket.assignee %}
                            <div class="mt-3 flex items-center space-x-2">
                                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xs font-medium">
                                    {{ ticket.assignee.first_name[0] }}{{ ticket.assignee.last_name[0] }}
                                </div>
                                <span class="text-sm text-gray-700">{{ ticket.assignee.full_name }}</span>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Tags -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                </svg>
                                Tags
                            </h3>
                            <button onclick="addTag()" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
                                + Add
                            </button>
                        </div>
                        <div id="tags-list" class="flex flex-wrap gap-2">
                            {% if ticket.tags %}
                                {% for tag in ticket.tags %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ tag.name }}
                                        <button hx-delete="{{ url_for('remove_tag_from_ticket', ticket_id=ticket.id, tag_id=tag.id) }}"
                                                hx-swap="none"
                                                hx-on:htmx:after-request="location.reload()"
                                                class="ml-1.5 text-blue-600 hover:text-blue-800">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-sm text-gray-500">No tags</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Related Tickets -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                Related Tickets
                            </h3>
                            <div class="relative">
                                <button onclick="toggleRelationshipMenu()" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
                                    + Add
                                </button>
                                <div id="relationship-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                    <div class="py-1">
                                        <button onclick="openMergeModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            Merge with...
                                        </button>
                                        <button onclick="openSplitModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            Split ticket...
                                        </button>
                                        <button onclick="openLinkModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            Link to ticket...
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="relationships-list"
                             hx-get="{{ url_for('get_ticket_relationships', ticket_id=ticket.id) }}"
                             hx-trigger="load, refreshRelationships from:body"
                             hx-swap="innerHTML">
                            <div class="text-sm text-gray-500">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col bg-white min-w-0 overflow-hidden">
            <!-- Ticket Header (Desktop) -->
            <header class="hidden lg:block px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-xl font-semibold text-gray-900 truncate">
                            {{ ticket.subject }}
                        </h1>
                        <div class="flex items-center mt-1 text-sm text-gray-600">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ ticket.get_relative_time() }}
                            <span class="mx-2">â€¢</span>
                            <span>{{ ticket.sender_email }}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Action Buttons -->
                        <button onclick="refreshTicket()"
                                title="Refresh ticket"
                                class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                        <div class="relative">
                            <button onclick="toggleTicketMenu()"
                                    title="More options"
                                    class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                                </svg>
                            </button>
                            <!-- Ticket Actions Dropdown -->
                            <div id="ticket-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                <div class="py-1">
                                    <button onclick="archiveTicket()"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                        </svg>
                                        Archive Ticket
                                    </button>
                                    <button onclick="deleteTicket()"
                                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Delete Ticket
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Conversation/Content Area -->
            <div id="conversation-panel" class="flex-1 overflow-y-auto mobile-panel max-w-full">
                <!-- Original Message -->
                <div class="px-4 lg:px-6 py-6">
                    <div class="bg-white border border-gray-200 rounded-xl p-6">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold">
                                    {{ (ticket.sender_name or ticket.sender_email)[0].upper() }}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">{{ ticket.sender_name or 'Customer' }}</p>
                                        <p class="text-xs text-gray-600">{{ ticket.sender_email }}</p>
                                    </div>
                                    <span class="text-xs text-gray-500">{{ ticket.get_relative_time() }}</span>
                                </div>
                                <div class="mt-3 email-content prose prose-sm max-w-none text-gray-800">
                                    {% if ticket.content_html %}
                                        {{ ticket.content_html|safe }}
                                    {% else %}
                                        <p>{{ ticket.content_text|replace('\n\n', '</p><p>')|replace('\n', '<br>')|safe }}</p>
                                    {% endif %}
                                </div>

                                {% set non_embedded_count = namespace(value=0) %}
                                {% for attachment in ticket.attachments %}
                                    {% if not attachment.is_embedded %}
                                        {% set non_embedded_count.value = non_embedded_count.value + 1 %}
                                    {% endif %}
                                {% endfor %}

                                {% if non_embedded_count.value > 0 %}
                                    <div class="mt-4">
                                        <p class="text-xs text-gray-500 mb-2">{{ non_embedded_count.value }} attachment{{ 's' if non_embedded_count.value != 1 else '' }}</p>
                                        <div class="flex flex-wrap gap-2">
                                            {% for attachment in ticket.attachments %}
                                                {% if not attachment.is_embedded %}
                                                <a href="{{ url_for('download_attachment', attachment_id=attachment.id) }}"
                                                   class="inline-flex items-center px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                                    </svg>
                                                    {{ attachment.filename }}
                                                    <span class="ml-1.5 text-gray-500">({{ attachment.get_file_size_human() }})</span>
                                                </a>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Replies -->
                <div id="replies-container" class="px-4 lg:px-6 space-y-4">
                    {% for reply in replies %}
                        <div class="group hover:bg-gray-50 rounded-xl transition-colors p-4">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="h-8 w-8 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-sm font-medium">
                                        {{ reply.agent.first_name[0] }}{{ reply.agent.last_name[0] }}
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">{{ reply.agent.full_name }}</p>
                                            <p class="text-xs text-gray-600">{{ reply.agent.role|title }}</p>
                                        </div>
                                        <span class="text-xs text-gray-500">{{ reply.get_relative_time() }}</span>
                                    </div>
                                    <div class="mt-2 email-content prose prose-sm max-w-none text-gray-800">
                                        {% if reply.content_html %}
                                            {{ reply.content_html|safe }}
                                        {% else %}
                                            <p>{{ reply.content|replace('\n\n', '</p><p>')|replace('\n', '<br>')|safe }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Reply Box (Sticky Bottom) -->
            <div class="border-t border-gray-200 bg-white px-4 lg:px-6 py-4">
                <form hx-post="{{ url_for('add_reply', ticket_id=ticket.id) }}"
                      hx-trigger="submit"
                      hx-swap="none"
                      hx-on:htmx:after-request="this.reset(); location.reload()">
                    <div class="flex items-end space-x-4">
                        <div class="flex-1">
                            <textarea name="content"
                                      rows="3"
                                      placeholder="Type your reply..."
                                      class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
                                      required></textarea>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <label class="inline-flex items-center text-sm">
                                <input type="checkbox" name="is_public" checked class="rounded text-blue-600">
                                <span class="ml-2 text-gray-600">Public</span>
                            </label>
                            <button type="submit"
                                    class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105">
                                Send Reply
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </main>

        <!-- Right Sidebar - Activity (Desktop) -->
        <aside id="activity-panel" class="hidden xl:flex w-80 bg-gray-50 border-l border-gray-200 flex-col flex-shrink-0 mobile-panel">
            <div class="px-6 py-5 border-b border-gray-200 bg-white">
                <h3 class="text-lg font-semibold text-gray-900">Activity Timeline</h3>
            </div>
            <div class="flex-1 overflow-y-auto px-6 py-4">
                <div id="timeline-container"
                     hx-get="{{ url_for('get_ticket_activities', ticket_id=ticket.id) }}"
                     hx-trigger="load, refreshTimeline from:body"
                     hx-swap="innerHTML">
                    <div class="text-sm text-gray-500">Loading timeline...</div>
                </div>
            </div>
        </aside>

        <!-- Details Panel (Mobile Only) -->
        <div id="details-panel" class="hidden mobile-panel lg:hidden bg-white">
            <div class="p-4 space-y-4">
                <!-- Mobile version of sidebar content -->
                <!-- Customer Info, Assignment, Tags, etc. -->
                <!-- (Same content as desktop sidebar but optimized for mobile) -->
            </div>
        </div>
    </div>
</div>

<script>
// Set ticket ID for JavaScript functions
window.TICKET_ID = {{ ticket.id }};

// Mobile tab switching
function switchTab(tabName) {
    // Hide all panels
    document.querySelectorAll('.mobile-panel').forEach(panel => {
        panel.classList.add('hidden');
    });

    // Show selected panel
    document.getElementById(tabName + '-panel').classList.remove('hidden');

    // Update tab styles
    document.querySelectorAll('.mobile-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
            tab.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
            tab.classList.remove('text-gray-600', 'border-transparent');
        } else {
            tab.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
            tab.classList.add('text-gray-600', 'border-transparent');
        }
    });
}

// Refresh ticket page
function refreshTicket() {
    location.reload();
}

// Toggle ticket menu
function toggleTicketMenu() {
    const menu = document.getElementById('ticket-menu');
    menu.classList.toggle('hidden');

    // Close menu when clicking outside
    if (!menu.classList.contains('hidden')) {
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('#ticket-menu') && !e.target.closest('[onclick*="toggleTicketMenu"]')) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 100);
    }
}

// Archive ticket
function archiveTicket() {
    if (confirm('Are you sure you want to archive this ticket?')) {
        fetch(`/api/ticket/${window.TICKET_ID}/archive`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Ticket archived successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/inbox';
                }, 1500);
            } else {
                showToast('Failed to archive ticket', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to archive ticket', 'error');
        });
    }
}

// Delete ticket
function deleteTicket() {
    if (confirm('Are you sure you want to delete this ticket? This action can be undone from the trash.')) {
        fetch(`/api/ticket/${window.TICKET_ID}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Ticket deleted successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/inbox';
                }, 1500);
            } else {
                showToast('Failed to delete ticket', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to delete ticket', 'error');
        });
    }
}

// Toggle relationship menu
function toggleRelationshipMenu() {
    const menu = document.getElementById('relationship-menu');
    menu.classList.toggle('hidden');
}

// Show toast notification
function showToast(message, type = 'success') {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast-notification');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform translate-y-full opacity-0';
        document.body.appendChild(toast);
    }

    // Set message and style
    toast.textContent = message;
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all transform ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;

    // Show toast
    setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
    }, 100);

    // Hide after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
    }, 3000);
}

// Toggle mobile menu
function toggleMobileMenu() {
    alert('Mobile menu would show: Profile, Settings, Logout');
}

// Add tag function
function addTag() {
    const tagName = prompt('Enter tag name:');
    if (tagName) {
        // Make API call to add tag
        fetch(`/api/ticket/${window.TICKET_ID}/add_tag`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tag_name: tagName })
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                showToast('Failed to add tag', 'error');
            }
        });
    }
}

// Initialize on mobile
if (window.innerWidth < 1024) {
    switchTab('conversation');
}

// Load external ticket view scripts if available
if (typeof initializeTicketView === 'function') {
    initializeTicketView();
}
</script>

<!-- Include ticket view JavaScript for modals -->
<script src="{{ url_for('static', filename='js/ticket-view.js') }}"></script>
{% endblock %}

{% block extra_css %}
<style>
/* Email content responsiveness */
.email-content {
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
}

.email-content * {
    max-width: 100% !important;
    height: auto !important;
}

.email-content img {
    display: block;
    max-width: 100% !important;
    height: auto !important;
}

.email-content table {
    table-layout: fixed;
    width: 100% !important;
    border-collapse: collapse;
}

.email-content pre,
.email-content code {
    white-space: pre-wrap;
    word-wrap: break-word;
    max-width: 100%;
    overflow-x: auto;
}

/* Remove any fixed widths from Gmail content */
.email-content div[style*="width"],
.email-content table[style*="width"] {
    width: 100% !important;
    max-width: 100% !important;
}

/* Smooth transitions */
* {
    transition-property: background-color, border-color, color, fill, stroke;
    transition-duration: 200ms;
}

/* Custom scrollbar */
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(107, 114, 128, 0.7);
}

/* Smooth animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .prose {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}