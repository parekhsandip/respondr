{% extends "base.html" %}

{% block title %}Inbox - Respondr{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header with Status Filters -->
    <div class="px-4 sm:px-6 py-4 bg-white border-b border-gray-200">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Tickets</h1>
                <p class="text-sm sm:text-base text-gray-600 mt-1">Manage customer support requests</p>
            </div>

            <!-- Advanced Search Toggle -->
            <div class="flex items-center gap-3">
                <button id="advanced-search-toggle"
                        onclick="toggleAdvancedSearch()"
                        class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span>Advanced Search</span>
                    <svg id="chevron-down" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Advanced Search Panel -->
        <div id="advanced-search-panel" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border">
            <form hx-get="{{ url_for('tickets_list') }}"
                  hx-target="#ticket-list"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                  hx-indicator="#search-indicator"
                  id="search-form">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">

                    <!-- Text Search -->
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" name="search" placeholder="Ticket content, sender, subject..."
                               value="{{ filters.search if filters else '' }}"
                               hx-get="{{ url_for('tickets_list') }}"
                               hx-target="#ticket-list"
                               hx-swap="innerHTML"
                               hx-trigger="keyup changed delay:500ms"
                               hx-include="form"
                               hx-indicator="#search-indicator"
                               hx-push-url="true"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Assignee -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Assignee</label>
                        <select name="assignee"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Assignees</option>
                            <option value="" {{ 'selected' if filters and filters.unassigned == 'true' else '' }}>Unassigned</option>
                            {% for agent in agents %}
                                <option value="{{ agent.id }}" {{ 'selected' if filters and filters.assignee == agent.id|string else '' }}>
                                    {{ agent.full_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Type -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                        <select name="type"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Types</option>
                            {% for ticket_type in ticket_types %}
                                <option value="{{ ticket_type.id }}" {{ 'selected' if filters and filters.type == ticket_type.id|string else '' }}>
                                    {{ ticket_type.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Priority -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                        <select name="priority"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Priorities</option>
                            <option value="1" {{ 'selected' if filters and filters.priority == '1' else '' }}>Urgent</option>
                            <option value="2" {{ 'selected' if filters and filters.priority == '2' else '' }}>High</option>
                            <option value="3" {{ 'selected' if filters and filters.priority == '3' else '' }}>Normal</option>
                            <option value="4" {{ 'selected' if filters and filters.priority == '4' else '' }}>Low</option>
                            <option value="5" {{ 'selected' if filters and filters.priority == '5' else '' }}>Lowest</option>
                        </select>
                    </div>

                    <!-- Organization -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Organization</label>
                        <select name="organization"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Organizations</option>
                            {% for org in organizations %}
                                <option value="{{ org.id }}" {{ 'selected' if filters and filters.organization == org.id|string else '' }}>
                                    {{ org.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Tags</label>
                        <select name="tag"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Tags</option>
                            {% for tag in tags %}
                                <option value="{{ tag.id }}" {{ 'selected' if filters and filters.tag == tag.id|string else '' }}>
                                    {{ tag.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Date From -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Created From</label>
                        <input type="date" name="created_from"
                               value="{{ filters.created_from if filters else '' }}"
                               hx-get="{{ url_for('tickets_list') }}"
                               hx-target="#ticket-list"
                               hx-swap="innerHTML"
                               hx-trigger="change"
                               hx-include="form"
                               hx-indicator="#search-indicator"
                               hx-push-url="true"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Date To -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Created To</label>
                        <input type="date" name="created_to"
                               value="{{ filters.created_to if filters else '' }}"
                               hx-get="{{ url_for('tickets_list') }}"
                               hx-target="#ticket-list"
                               hx-swap="innerHTML"
                               hx-trigger="change"
                               hx-include="form"
                               hx-indicator="#search-indicator"
                               hx-push-url="true"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center gap-2">
                        <label class="flex items-center text-sm text-gray-600">
                            <input type="checkbox" name="unassigned" value="true"
                                   {{ 'checked' if filters and filters.unassigned else '' }}
                                   hx-get="{{ url_for('tickets_list') }}"
                                   hx-target="#ticket-list"
                                   hx-swap="innerHTML"
                                   hx-trigger="change"
                                   hx-include="form"
                                   hx-indicator="#search-indicator"
                                   hx-push-url="true"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
                            Show only unassigned tickets
                        </label>
                    </div>

                    <div class="flex items-center gap-2">
                        <button type="button" onclick="clearSearch()"
                                class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors">
                            Clear
                        </button>
                        <button type="submit"
                                hx-get="{{ url_for('tickets_list') }}"
                                hx-target="#ticket-list"
                                hx-swap="innerHTML"
                                hx-include="form"
                                hx-indicator="#search-indicator"
                                hx-push-url="true"
                                class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Search
                        </button>
                    </div>
                </div>

                <!-- Preserve status filter -->
                <input type="hidden" name="status" value="{{ status_filter }}">
            </form>

            <!-- Search Loading Indicator -->
            <div id="search-indicator" class="htmx-indicator mt-2 text-center">
                <div class="inline-flex items-center px-3 py-2 text-sm text-blue-600 bg-blue-50 rounded-md">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="m15.84 10.2c.1-.1.1-.2.2-.3.1-.1.3-.1.4-.1s.3.1.4.1c.1.1.1.2.2.3l1.9 3.3c.1.1.1.2.1.3 0 .1 0 .2-.1.3-.1.1-.2.1-.3.1-.1 0-.2 0-.3-.1l-1.9-3.3zm-11.5 9.5c-.1.1-.2.1-.3.1-.1 0-.2 0-.3-.1-.1-.1-.1-.2-.1-.3 0-.1 0-.2.1-.3l1.9-3.3c.1-.1.2-.1.3-.1.1 0 .2 0 .3.1.1.1.1.2.1.3 0 .1 0 .2-.1.3l-1.9 3.3zm6.4-8.4c-.1-.1-.1-.2-.2-.3-.1-.1-.3-.1-.4-.1s-.3.1-.4.1c-.1.1-.1.2-.2.3l-1.9 3.3c-.1.1-.1.2-.1.3 0 .1 0 .2.1.3.1.1.2.1.3.1.1 0 .2 0 .3-.1l1.9-3.3z"></path>
                    </svg>
                    Searching...
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filters - Responsive -->
    <div class="px-4 sm:px-6 py-3 bg-white border-b border-gray-200">
            <div class="flex items-center flex-wrap gap-1 bg-gray-50 rounded-lg border border-gray-200 p-1 lg:flex-nowrap lg:space-x-1">
                <a href="{{ url_for('index', status='all', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'all' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center">
                    All
                </a>
                <a href="{{ url_for('index', status='new', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'new' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center">
                    New
                </a>
                <a href="{{ url_for('index', status='open', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'open' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center">
                    Open
                </a>
                <a href="{{ url_for('index', status='pending', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'pending' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center hidden sm:block">
                    Pending
                </a>
                <a href="{{ url_for('index', status='solved', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'solved' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center hidden sm:block">
                    Solved
                </a>
                <a href="{{ url_for('index', status='closed', search=request.args.get('search', '')) }}"
                   class="{% if status_filter == 'closed' %}bg-blue-600 text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %} px-2 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-md transition-colors flex-1 sm:flex-initial text-center">
                    Closed
                </a>
            </div>
        </div>
    </div>

    <!-- Ticket Table - Full Width -->
    <div class="flex-1 min-h-0">
        <div id="ticket-list" class="h-full">
            {% include 'components/ticket_table.html' %}
        </div>
    </div>
</div>

<!-- Ticket Detail Modal -->
<div id="ticket-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-w-[95vw]">
            <div id="ticket-modal-content">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/inbox.js') }}?v={{ asset_version('js/pages/inbox.js') }}"></script>
<script>
// Advanced Search Functions
function toggleAdvancedSearch() {
    const panel = document.getElementById('advanced-search-panel');
    const chevron = document.getElementById('chevron-down');

    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
    } else {
        panel.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
    }
}

function clearSearch() {
    const form = document.getElementById('search-form');
    const inputs = form.querySelectorAll('input[type="text"], input[type="date"], select');

    inputs.forEach(input => {
        if (input.type === 'text' || input.type === 'date') {
            input.value = '';
        } else if (input.tagName === 'SELECT') {
            input.value = 'all';
        }
    });

    // Uncheck checkbox
    const unassignedCheckbox = form.querySelector('input[name="unassigned"]');
    if (unassignedCheckbox) {
        unassignedCheckbox.checked = false;
    }

    // Use HTMX to trigger search with cleared values
    htmx.trigger(form, 'submit');
}

// HTMX event handlers for search feedback
document.addEventListener('htmx:beforeRequest', function(e) {
    // Show search indicator when any search request starts
    const indicator = document.getElementById('search-indicator');
    if (indicator) {
        indicator.classList.remove('hidden');
    }
});

document.addEventListener('htmx:afterRequest', function(e) {
    // Hide search indicator when any request completes
    const indicator = document.getElementById('search-indicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
});
</script>
{% endblock %}