{% extends "base.html" %}

{% block title %}Integrations - Settings - Respondr{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Breadcrumb Navigation -->
    {% set breadcrumb_title = 'Integrations' %}
    {% include 'settings/components/breadcrumb.html' %}

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-gray-900">Integrations</h1>
            <p class="mt-1 text-sm text-gray-600">Configure external integrations and embed widgets</p>
        </div>

        <!-- Widget Integration Section -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path>
                </svg>
                Website Widget
            </h2>
            <p class="mt-1 text-sm text-gray-600">Embed a support widget on your website to let customers submit tickets directly</p>
        </div>

        <div class="p-6">
            <!-- Widget Configuration Form -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Configuration Panel -->
                <div>
                    <h3 class="text-base font-medium text-gray-900 mb-4">Widget Configuration</h3>

                    <form id="widget-config-form" class="space-y-4">
                        <!-- Widget Status -->
                        <div class="flex items-center justify-between py-2">
                            <div>
                                <label for="widget-enabled" class="text-sm font-medium text-gray-700">Enable Widget</label>
                                <p class="text-xs text-gray-500">Allow the widget to be embedded and accept submissions</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="widget-enabled" name="enabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Primary Color -->
                        <div>
                            <label for="widget-color" class="block text-sm font-medium text-gray-700 mb-1">
                                Primary Color
                            </label>
                            <div class="flex items-center space-x-3">
                                <input type="color" id="widget-color" name="primary_color" value="#3B82F6"
                                       class="h-10 w-16 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <input type="text" id="widget-color-hex" value="#3B82F6"
                                       class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       placeholder="#3B82F6">
                            </div>
                        </div>

                        <!-- Button Position -->
                        <div>
                            <label for="widget-position" class="block text-sm font-medium text-gray-700 mb-1">
                                Button Position
                            </label>
                            <select id="widget-position" name="position"
                                    class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <option value="bottom-right">Bottom Right</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="top-right">Top Right</option>
                                <option value="top-left">Top Left</option>
                            </select>
                        </div>

                        <!-- Welcome Message -->
                        <div>
                            <label for="widget-welcome" class="block text-sm font-medium text-gray-700 mb-1">
                                Welcome Message
                            </label>
                            <textarea id="widget-welcome" name="welcome_message" rows="2"
                                      class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                      placeholder="Hi! How can we help you today?">Hi! How can we help you today?</textarea>
                        </div>

                        <!-- Required Fields -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Required Fields</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="require-name" name="require_name" checked
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="require-name" class="ml-2 block text-sm text-gray-700">Name</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="require-email" name="require_email" checked disabled
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="require-email" class="ml-2 block text-sm text-gray-700">Email (always required)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="require-subject" name="require_subject" checked
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="require-subject" class="ml-2 block text-sm text-gray-700">Subject</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="allow-attachments" name="allow_attachments"
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="allow-attachments" class="ml-2 block text-sm text-gray-700">Allow Attachments</label>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Restrictions -->
                        <div>
                            <label for="allowed-domains" class="block text-sm font-medium text-gray-700 mb-1">
                                Allowed Domains
                            </label>
                            <textarea id="allowed-domains" name="allowed_domains" rows="2"
                                      class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                      placeholder="example.com&#10;sub.example.com&#10;(Leave empty to allow all domains)"></textarea>
                            <p class="mt-1 text-xs text-gray-500">One domain per line. Leave empty to allow all domains.</p>
                        </div>

                        <!-- Save Button -->
                        <div class="pt-4">
                            <button type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Save Configuration
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Preview Panel -->
                <div>
                    <h3 class="text-base font-medium text-gray-900 mb-4">Preview</h3>

                    <!-- Widget Preview Container -->
                    <div class="border-2 border-gray-200 rounded-lg bg-gray-50 relative" style="height: 400px;">
                        <div class="absolute inset-0 flex items-center justify-center text-sm text-gray-500">
                            Widget preview will appear here
                        </div>

                        <!-- Widget Button Preview -->
                        <div id="widget-preview-button"
                             class="absolute bottom-4 right-4 w-14 h-14 rounded-full shadow-lg cursor-pointer flex items-center justify-center text-white transition-transform hover:scale-110"
                             style="background-color: #3B82F6;">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Widget Stats -->
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="bg-white border border-gray-200 rounded-lg p-3">
                            <div class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-500">Submissions Today</div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-3">
                            <div class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-xs text-gray-500">Total Submissions</div>
                        </div>
                    </div>

                    <!-- Test Widget Button -->
                    <div class="mt-4">
                        <button onclick="openWidgetSimulation()"
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M7 7l10 10M17 7l-10 10"></path>
                            </svg>
                            Test Widget
                        </button>
                        <p class="mt-1 text-xs text-gray-500 text-center">Opens simulation in new tab</p>
                    </div>
                </div>
            </div>

            <!-- Installation Instructions -->
            <div class="mt-8 border-t border-gray-200 pt-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">Installation</h3>

                <!-- Instructions Tabs -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showInstallTab('embed')"
                                id="embed-tab"
                                class="tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Embed Code
                        </button>
                        <button onclick="showInstallTab('script')"
                                id="script-tab"
                                class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Script Tag
                        </button>
                        <button onclick="showInstallTab('iframe')"
                                id="iframe-tab"
                                class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            iFrame
                        </button>
                    </nav>
                </div>

                <!-- Embed Code Tab -->
                <div id="embed-content" class="install-content">
                    <p class="text-sm text-gray-600 mb-3">Copy and paste this code into your website's HTML, preferably before the closing &lt;/body&gt; tag:</p>
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-xs">HTML</span>
                            <button onclick="copyToClipboard('embed-code')"
                                    class="text-gray-400 hover:text-white text-xs flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy
                            </button>
                        </div>
                        <pre id="embed-code" class="text-green-400 text-sm overflow-x-auto"><code>&lt;!-- Respondr Support Widget --&gt;
&lt;script&gt;
  window.RespondrWidget = {
    apiUrl: '{{ request.url_root }}',
    primaryColor: '#3B82F6',
    position: 'bottom-right',
    welcomeMessage: 'Hi! How can we help you today?'
  };
&lt;/script&gt;
&lt;script src="{{ request.url_root }}static/js/widget.js"&gt;&lt;/script&gt;</code></pre>
                    </div>
                </div>

                <!-- Script Tag Tab -->
                <div id="script-content" class="install-content hidden">
                    <p class="text-sm text-gray-600 mb-3">For more control, you can load the widget asynchronously:</p>
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-xs">JavaScript</span>
                            <button onclick="copyToClipboard('script-code')"
                                    class="text-gray-400 hover:text-white text-xs flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy
                            </button>
                        </div>
                        <pre id="script-code" class="text-green-400 text-sm overflow-x-auto"><code>(function() {
  var script = document.createElement('script');
  script.src = '{{ request.url_root }}static/js/widget.js';
  script.async = true;
  window.RespondrWidget = {
    apiUrl: '{{ request.url_root }}',
    primaryColor: '#3B82F6',
    position: 'bottom-right',
    welcomeMessage: 'Hi! How can we help you today?'
  };
  document.head.appendChild(script);
})();</code></pre>
                    </div>
                </div>

                <!-- iFrame Tab -->
                <div id="iframe-content" class="install-content hidden">
                    <p class="text-sm text-gray-600 mb-3">For the most isolated approach, embed the widget as an iframe:</p>
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-400 text-xs">HTML</span>
                            <button onclick="copyToClipboard('iframe-code')"
                                    class="text-gray-400 hover:text-white text-xs flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Copy
                            </button>
                        </div>
                        <pre id="iframe-code" class="text-green-400 text-sm overflow-x-auto"><code>&lt;iframe src="{{ request.url_root }}widget"
        width="400"
        height="600"
        frameborder="0"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"&gt;
&lt;/iframe&gt;</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Integration Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                </svg>
                API Integration
            </h2>
            <p class="mt-1 text-sm text-gray-600">Direct API endpoints for creating tickets programmatically</p>
        </div>

        <div class="p-6">
            <!-- API Documentation -->
            <div class="space-y-6">
                <div>
                    <h3 class="text-base font-medium text-gray-900 mb-2">Create Ticket Endpoint</h3>
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="text-green-400 text-sm font-mono">POST {{ request.url_root }}api/widget/submit</div>
                    </div>

                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Request Body</h4>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <pre class="text-sm text-gray-700"><code>{
  "name": "John Doe",
  "email": "john@example.com",
  "subject": "Need help with account",
  "message": "I'm having trouble accessing my account...",
  "attachments": [] // Optional
}</code></pre>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Response</h4>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <pre class="text-sm text-gray-700"><code>{
  "success": true,
  "ticket_id": 123,
  "ticket_number": "TCK-001234",
  "message": "Ticket created successfully"
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Open widget simulation in new tab
function openWidgetSimulation() {
    // Get current configuration
    const config = {
        primaryColor: document.getElementById('widget-color').value,
        position: document.getElementById('widget-position').value,
        welcomeMessage: document.getElementById('widget-welcome').value,
        requireName: document.getElementById('require-name').checked,
        requireSubject: document.getElementById('require-subject').checked,
        allowAttachments: document.getElementById('allow-attachments').checked
    };

    // Create URL with configuration parameters
    const params = new URLSearchParams(config);
    const url = `/widget-simulate?${params.toString()}`;

    // Open in new tab (without window features to prevent popup)
    window.open(url, '_blank');
}

// Widget configuration functions
function showInstallTab(tabName) {
    // Hide all content
    document.querySelectorAll('.install-content').forEach(content => {
        content.classList.add('hidden');
    });

    // Remove active state from all tabs
    document.querySelectorAll('.tab-button').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });

    // Show selected content
    document.getElementById(tabName + '-content').classList.remove('hidden');

    // Activate selected tab
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-blue-500', 'text-blue-600');
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;

    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const button = element.parentNode.querySelector('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Copied!';

        setTimeout(() => {
            button.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

// Update widget preview when configuration changes
function updateWidgetPreview() {
    const color = document.getElementById('widget-color').value;
    const position = document.getElementById('widget-position').value;
    const button = document.getElementById('widget-preview-button');

    // Update button color
    button.style.backgroundColor = color;

    // Update button position
    button.className = button.className.replace(/top-4|bottom-4|left-4|right-4/g, '');

    if (position.includes('top')) {
        button.classList.add('top-4');
    } else {
        button.classList.add('bottom-4');
    }

    if (position.includes('left')) {
        button.classList.add('left-4');
    } else {
        button.classList.add('right-4');
    }
}

// Sync color picker and hex input
document.getElementById('widget-color').addEventListener('input', function() {
    document.getElementById('widget-color-hex').value = this.value;
    updateWidgetPreview();
});

document.getElementById('widget-color-hex').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('widget-color').value = this.value;
        updateWidgetPreview();
    }
});

// Update preview when position changes
document.getElementById('widget-position').addEventListener('change', updateWidgetPreview);

// Handle form submission
document.getElementById('widget-config-form').addEventListener('submit', function(e) {
    e.preventDefault();

    // Here you would typically send the configuration to the server
    alert('Widget configuration saved successfully!');
});

// Initialize preview
document.addEventListener('DOMContentLoaded', function() {
    updateWidgetPreview();
});
</script>
{% endblock %}