{% extends "base.html" %}

{% block title %}System Settings{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Breadcrumb Navigation -->
    {% set breadcrumb_title = 'System Settings' %}
    {% include 'settings/components/breadcrumb.html' %}

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">System Settings</h1>
            <p class="mt-2 text-gray-600">Configure your email connection and application preferences</p>
        </div>

        <div class="space-y-8">
                <!-- Email Configuration -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">Email Configuration</h2>
                        <p class="text-sm text-gray-600 mt-1">Configure your IMAP settings to fetch emails</p>
                    </div>

                    <div class="px-6 py-6">
                        <form id="email-config-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- IMAP Server -->
                                <div>
                                    <label for="imap_server" class="block text-sm font-medium text-gray-700">IMAP Server</label>
                                    <input
                                        type="text"
                                        id="imap_server"
                                        name="imap_server"
                                        placeholder="imap.gmail.com"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Your email provider's IMAP server address</p>
                                </div>

                                <!-- IMAP Port -->
                                <div>
                                    <label for="imap_port" class="block text-sm font-medium text-gray-700">IMAP Port</label>
                                    <input
                                        type="number"
                                        id="imap_port"
                                        name="imap_port"
                                        placeholder="993"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Usually 993 for SSL or 143 for non-SSL</p>
                                </div>

                                <!-- Username -->
                                <div>
                                    <label for="imap_username" class="block text-sm font-medium text-gray-700">Username/Email</label>
                                    <input
                                        type="text"
                                        id="imap_username"
                                        name="imap_username"
                                        placeholder="your-email@example.com"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>

                                <!-- Password -->
                                <div>
                                    <label for="imap_password" class="block text-sm font-medium text-gray-700">Password</label>
                                    <input
                                        type="password"
                                        id="imap_password"
                                        name="imap_password"
                                        placeholder="Your app password or regular password"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>

                            <!-- Use SSL -->
                            <div class="flex items-center">
                                <input
                                    id="imap_use_ssl"
                                    name="imap_use_ssl"
                                    type="checkbox"
                                    checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="imap_use_ssl" class="ml-2 block text-sm text-gray-900">Use SSL/TLS encryption</label>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-4">
                                <button
                                    type="button"
                                    id="test-connection"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Test Connection
                                </button>
                                <button
                                    type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sync Settings -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">Sync Settings</h2>
                        <p class="text-sm text-gray-600 mt-1">Configure how often emails are fetched</p>
                    </div>

                    <div class="px-6 py-6">
                        <form id="sync-settings-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Fetch Interval -->
                                <div>
                                    <label for="fetch_interval" class="block text-sm font-medium text-gray-700">Fetch Interval (minutes)</label>
                                    <input
                                        type="number"
                                        id="fetch_interval"
                                        name="fetch_interval"
                                        value="5"
                                        min="1"
                                        max="60"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">How often to check for new emails (1-60 minutes)</p>
                                </div>

                                <!-- Max Emails -->
                                <div>
                                    <label for="max_emails_per_sync" class="block text-sm font-medium text-gray-700">Max Emails per Sync</label>
                                    <input
                                        type="number"
                                        id="max_emails_per_sync"
                                        name="max_emails_per_sync"
                                        value="50"
                                        min="10"
                                        max="200"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Maximum number of emails to process in each sync</p>
                                </div>
                            </div>

                            <button
                                type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Save Sync Settings
                            </button>
                        </form>
                    </div>
                </div>

                <!-- File Settings -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">File Settings</h2>
                        <p class="text-sm text-gray-600 mt-1">Configure file upload and storage settings</p>
                    </div>

                    <div class="px-6 py-6">
                        <form id="file-settings-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Max File Size -->
                                <div>
                                    <label for="max_attachment_size" class="block text-sm font-medium text-gray-700">Max Attachment Size (MB)</label>
                                    <input
                                        type="number"
                                        id="max_attachment_size"
                                        name="max_attachment_size"
                                        value="25"
                                        min="1"
                                        max="100"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Maximum size for email attachments</p>
                                </div>

                                <!-- Storage Path -->
                                <div>
                                    <label for="attachment_storage_path" class="block text-sm font-medium text-gray-700">Storage Path</label>
                                    <input
                                        type="text"
                                        id="attachment_storage_path"
                                        name="attachment_storage_path"
                                        value="attachments"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <p class="mt-1 text-xs text-gray-500">Directory to store attachments (relative to app root)</p>
                                </div>
                            </div>

                            <button
                                type="submit"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Save File Settings
                            </button>
                        </form>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">System Status</h2>
                        <p class="text-sm text-gray-600 mt-1">Current system status and connectivity</p>
                    </div>

                    <div class="px-6 py-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                                    <span class="text-sm font-medium text-gray-900">Email Connection</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Last checked: <span id="last-email-check">--</span></p>
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                                    <span class="text-sm font-medium text-gray-900">Database</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Active connections: <span id="db-connections">--</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>

<script>
// Load current settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});

function loadSettings() {
    // Load email settings
    fetch('/api/settings/email')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                document.getElementById('imap_server').value = settings.imap_server || '';
                document.getElementById('imap_port').value = settings.imap_port || 993;
                document.getElementById('imap_username').value = settings.imap_username || '';
                document.getElementById('imap_password').value = settings.imap_password || '';
                document.getElementById('imap_use_ssl').checked = settings.imap_use_ssl !== 'false';
            }
        })
        .catch(error => console.error('Error loading email settings:', error));

    // Load sync settings
    fetch('/api/settings/sync')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                document.getElementById('fetch_interval').value = settings.fetch_interval || 5;
                document.getElementById('max_emails_per_sync').value = settings.max_emails_per_sync || 50;
            }
        })
        .catch(error => console.error('Error loading sync settings:', error));

    // Load file settings
    fetch('/api/settings/files')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.settings;
                document.getElementById('max_attachment_size').value = settings.max_attachment_size || 25;
                document.getElementById('attachment_storage_path').value = settings.attachment_storage_path || 'attachments';
            }
        })
        .catch(error => console.error('Error loading file settings:', error));
}

// Email settings form
document.getElementById('email-config-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const settings = {};
    for (let [key, value] of formData.entries()) {
        if (key === 'imap_use_ssl') {
            settings[key] = 'true';
        } else {
            settings[key] = value;
        }
    }

    // Add unchecked checkbox
    if (!formData.has('imap_use_ssl')) {
        settings['imap_use_ssl'] = 'false';
    }

    fetch('/api/settings/email', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Email settings saved successfully', 'success');
        } else {
            showToast('Error saving email settings: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error saving email settings', 'error');
        console.error('Error:', error);
    });
});

// Test connection
document.getElementById('test-connection').addEventListener('click', function() {
    const button = this;
    button.textContent = 'Testing...';
    button.disabled = true;

    fetch('/api/test-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Connection test successful', 'success');
        } else {
            showToast('Connection test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Connection test failed', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        button.textContent = 'Test Connection';
        button.disabled = false;
    });
});

// Sync settings form
document.getElementById('sync-settings-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const settings = {};
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }

    fetch('/api/settings/sync', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Sync settings saved successfully', 'success');
        } else {
            showToast('Error saving sync settings: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error saving sync settings', 'error');
        console.error('Error:', error);
    });
});

// File settings form
document.getElementById('file-settings-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const settings = {};
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }

    fetch('/api/settings/files', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File settings saved successfully', 'success');
        } else {
            showToast('Error saving file settings: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showToast('Error saving file settings', 'error');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}